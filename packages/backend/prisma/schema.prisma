generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Listing {
  id            String   @id @default(cuid())
  onchainId     Int      @unique
  sellerAddress String
  dataCID       String
  spaceDID      String
  title         String
  description   String
  category      String
  priceUsdc     Decimal  @db.Decimal(18, 6)
  active        Boolean  @default(true)
  encVersion    String   @default("v1")
  encAlgorithm  String   @default("AES-256-GCM")
  encIvLen      Int      @default(12)
  origFilename  String?
  contentType   String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  purchases     Purchase[]

  @@index([active, category])
  @@index([sellerAddress])
  @@index([createdAt])
}

model Purchase {
  id                  String    @id @default(cuid())
  listingId           String
  listing             Listing   @relation(fields: [listingId], references: [id])
  buyerAddress        String
  txHash              String    @unique
  amountUsdc          Decimal   @db.Decimal(18, 6)
  txVerified          Boolean   @default(false)
  blockNumber         Int?
  buyerPublicKey      String?
  publicKeySignature  String?
  encryptedKey        String?
  keyDelivered        Boolean   @default(false)
  keyDeliveredAt      DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@unique([listingId, buyerAddress])
  @@index([buyerAddress])
  @@index([txVerified])
  @@index([keyDelivered])
}

model EventLog {
  id          String   @id @default(cuid())
  eventType   String
  txHash      String
  blockNumber Int
  logIndex    Int
  processed   Boolean  @default(false)
  error       String?
  data        Json?
  createdAt   DateTime @default(now())

  @@unique([txHash, logIndex])
  @@index([processed])
  @@index([eventType])
  @@index([blockNumber])
}
